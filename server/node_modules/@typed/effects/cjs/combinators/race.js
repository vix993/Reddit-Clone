"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.race = void 0;
const disposable_1 = require("@typed/disposable");
const env_1 = require("@typed/env");
const run_1 = require("../run");
function* race(...effects) {
    const env = (c) => env_1.Resume.create((cb) => {
        const disposable = disposable_1.Disposable.lazy();
        const ifNotResolved = createIfNotResolved(cb, disposable);
        for (const effect of effects) {
            const pure = env_1.provide(run_1.runEffect(effect), c);
            disposable.addDisposable(env_1.runPure(ifNotResolved, pure));
        }
        return disposable;
    });
    return yield env;
}
exports.race = race;
function createIfNotResolved(cb, disposable) {
    let resolved = false;
    return (value) => {
        if (!resolved) {
            resolved = true;
            disposable.dispose();
            return cb(value);
        }
        return disposable_1.Disposable.None;
    };
}
//# sourceMappingURL=race.js.map